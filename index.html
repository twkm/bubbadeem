<!DOCTYPE html>
<html>
<head>
    <title>Bubbadeem</title>
    <!--
    [Live Game](https://cdn.rawgit.com/twkm/bubbadeem/dcb7f8d1/index.html)
    [Development Preview](https://rawgit.com/twkm/bubbadeem/master/index.html)
    [Gameloop - The Correct Way](https://coderwall.com/p/iygcpa/gameloop-the-correct-way)
    [Change SVG fill colour to Canvas](https://stackoverflow.com/questions/27596652/change-svg-fill-color-and-then-draw-to-canvas)
    -->
    <style type="text/css">

    /* https://google-webfonts-helper.herokuapp.com/fonts */
    /* modak-regular - latin */
    @font-face {
        font-family: 'Modak';
        font-style: normal;
        font-weight: 400;
        src: local('Modak'),
            url('resources/fonts/modak-v2-latin-regular.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/modak-v2-latin-regular.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }/* roboto-100 - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: normal;
        font-weight: 100;
        src: local('Roboto Thin'), local('Roboto-Thin'),
            url('resources/fonts/roboto-v16-latin-100.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-100.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-100italic - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: italic;
        font-weight: 100;
        src: local('Roboto Thin Italic'), local('Roboto-ThinItalic'),
            url('resources/fonts/roboto-v16-latin-100italic.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-100italic.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-300 - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: normal;
        font-weight: 300;
        src: local('Roboto Light'), local('Roboto-Light'),
            url('resources/fonts/roboto-v16-latin-300.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-300.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-300italic - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: italic;
        font-weight: 300;
        src: local('Roboto Light Italic'), local('Roboto-LightItalic'),
            url('resources/fonts/roboto-v16-latin-300italic.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-300italic.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-regular - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: normal;
        font-weight: 400;
        src: local('Roboto'), local('Roboto-Regular'),
            url('resources/fonts/roboto-v16-latin-regular.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-regular.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-italic - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: italic;
        font-weight: 400;
        src: local('Roboto Italic'), local('Roboto-Italic'),
            url('resources/fonts/roboto-v16-latin-italic.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-italic.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-500 - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: normal;
        font-weight: 500;
        src: local('Roboto Medium'), local('Roboto-Medium'),
            url('resources/fonts/roboto-v16-latin-500.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-500.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-500italic - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: italic;
        font-weight: 500;
        src: local('Roboto Medium Italic'), local('Roboto-MediumItalic'),
            url('resources/fonts/roboto-v16-latin-500italic.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-500italic.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-700 - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: normal;
        font-weight: 700;
        src: local('Roboto Bold'), local('Roboto-Bold'),
            url('resources/fonts/roboto-v16-latin-700.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-700.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-700italic - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: italic;
        font-weight: 700;
        src: local('Roboto Bold Italic'), local('Roboto-BoldItalic'),
            url('resources/fonts/roboto-v16-latin-700italic.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-700italic.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-900 - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: normal;
        font-weight: 900;
        src: local('Roboto Black'), local('Roboto-Black'),
            url('resources/fonts/roboto-v16-latin-900.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-900.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* roboto-900italic - latin */
    @font-face {
        font-family: 'Roboto';
        font-style: italic;
        font-weight: 900;
        src: local('Roboto Black Italic'), local('Roboto-BlackItalic'),
            url('resources/fonts/roboto-v16-latin-900italic.woff2') format('woff2'), /* Chrome 26+, Opera 23+, Firefox 39+ */
            url('resources/fonts/roboto-v16-latin-900italic.woff') format('woff'); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }

    html {
        min-height: 100vh;
    }

    body {
        margin: 0;
        padding: 0;
        height: 100vh;
        background-color: #000;
    }

    div {
        margin: 0;
        padding: 0;
    }

    canvas {
        display: block;
        cursor: pointer;
        position: relative;
    }

    #game_wrapper {
        border: 1px solid #000;
    }

    #game_canvas {
        display: block;
        position: relative;
        left: 50%;
        top: 50%;
        background-image: url('resources/backgrounds/mountains_1_transp.png');
        background-size: cover;
        background-color: #FFF;
    }

    </style>
    <script type="text/javascript">

        function Bubbadeem(canvas, settings = null) {
            this.canvas = canvas;
            this.canvas_base_width = 1000;
            this.size_multiplier = this.canvas.width / this.canvas_base_width;
            this.sizeUtil = (size) => {
                return size * this.size_multiplier;
            }
            this.gamearea = {
                'width' : this.sizeUtil(1000),
                'height' : this.sizeUtil(477)
            };
            this.draw_cx = null;
            this.fps = 30;
            this.interval = 1000/this.fps;
            this.game_time = 0;
            this.last_time = (new Date()).getTime();
            this.current_time = 0;
            this.delta = 0;
            this.max_bubbles = 30;
            this.max_bubble_speed = this.sizeUtil(3);
            this.bubbles = new Array();
            this.bubble_image_code='data:image/svg+xml;charset=utf-8,<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n                <!-- Created with Inkscape (http://www.inkscape.org/) -->\n\n                <svg\n                   xmlns:dc="http://purl.org/dc/elements/1.1/"\n                   xmlns:cc="http://creativecommons.org/ns#"\n                   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n                   xmlns:svg="http://www.w3.org/2000/svg"\n                   xmlns="http://www.w3.org/2000/svg"\n                   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"\n                   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"\n                   width="63.855083"\n                   height="63.855083"\n                   viewBox="0 0 16.894991 16.894991"\n                   version="1.1"\n                   id="svg8"\n                   inkscape:version="0.92.2 5c3e80d, 2017-08-06"\n                   sodipodi:docname="bubble.svg">\n                  <defs\n                     id="defs2" />\n                  <sodipodi:namedview\n                     id="base"\n                     pagecolor="#ffffff"\n                     bordercolor="#666666"\n                     borderopacity="1.0"\n                     inkscape:pageopacity="0.0"\n                     inkscape:pageshadow="2"\n                     inkscape:zoom="7.9195959"\n                     inkscape:cx="70.356621"\n                     inkscape:cy="37.308622"\n                     inkscape:document-units="mm"\n                     inkscape:current-layer="layer1"\n                     showgrid="false"\n                     units="px"\n                     inkscape:window-width="1920"\n                     inkscape:window-height="810"\n                     inkscape:window-x="1763"\n                     inkscape:window-y="134"\n                     inkscape:window-maximized="0" />\n                  <metadata\n                     id="metadata5">\n                    <rdf:RDF>\n                      <cc:Work\n                         rdf:about="">\n                        <dc:format>image/svg+xml</dc:format>\n                        <dc:type\n                           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n                        <dc:title></dc:title>\n                      </cc:Work>\n                    </rdf:RDF>\n                  </metadata>\n                  <g\n                     inkscape:label="Layer 1"\n                     inkscape:groupmode="layer"\n                     id="layer1"\n                     transform="translate(-52.222686,-180.04106)">\n                    <path\n                       style="opacity:0.25;fill:#000000;fill-opacity:0.10499998;stroke:none;stroke-width:2.70583963;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                       d="m 256.39648,137.52734 a 17.855302,42.143408 52.167749 0 0 -1.30468,0.35157 35.034683,35.034683 0 0 1 0.47851,5.69336 35.034683,35.034683 0 0 1 -35.03515,35.0332 35.034683,35.034683 0 0 1 -9.63086,-1.41406 30.927541,30.927541 0 0 0 18.40039,6.11328 30.927541,30.927541 0 0 0 30.92773,-30.92578 30.927541,30.927541 0 0 0 -3.83594,-14.85157 z"\n                       transform="matrix(0.26458333,0,0,0.26458333,0,148.17186)"\n                       id="path867"\n                       inkscape:connector-curvature="0" />\n                    <circle\n                       style="opacity:0.25;fill:#e82444;fill-opacity:1;stroke:none;stroke-width:0.52916676;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                       id="path815-7"\n                       cx="60.670181"\n                       cy="188.48856"\n                       r="8.1829119" />\n                    <ellipse\n                       style="opacity:0.25;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:0.80988121;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                       id="path832-3"\n                       cx="-12.371008"\n                       cy="193.25958"\n                       rx="4.4046226"\n                       ry="3.3429554"\n                       transform="rotate(-21.18424)" />\n                    <ellipse\n                       style="opacity:0.25;fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:0.52916664;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                       id="path832"\n                       cx="13.078985"\n                       cy="192.42632"\n                       rx="2.9399648"\n                       ry="2.1381562"\n                       transform="rotate(-13.61174)" />\n                    <ellipse\n                       style="opacity:0.25;fill:#000000;fill-opacity:0.10499998;stroke:none;stroke-width:0.80988121;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                       id="path832-3-8"\n                       cx="27.201355"\n                       cy="-200.60611"\n                       rx="4.4046226"\n                       ry="3.3429551"\n                       transform="rotate(154.19452)" />\n                    <ellipse\n                       style="opacity:0.25;fill:#000000;fill-opacity:0.10499998;stroke:none;stroke-width:0.52916664;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                       id="path832-2"\n                       cx="0.40236369"\n                       cy="-203.21933"\n                       rx="2.9399648"\n                       ry="2.1381562"\n                       transform="rotate(161.76702)" />\n                    <circle\n                       style="opacity:1;fill:none;fill-opacity:1;stroke:#000000;stroke-width:0.5291667;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                       id="path815"\n                       cx="60.670181"\n                       cy="188.48856"\n                       r="8.1829119" />\n                  </g>\n                </svg>\n';
            this.colour_options = [
                '#e82444',
                '#119e33',
                '#1723df',
                '#d017df',
                '#f175d9',
                '#f1e475',
                '#d4c016',
                '#16d4af',
                '#d46b16'
            ];
            this.bubble_images = new Array();
            this.sounds = {
                'bubbadeem' : {
                    'intro' : 'intro.mp3',
                    'pause' : 'pause.mp3',
                    'start' : 'start.mp3',
                    'pop' : [
                        'pop.mp3'
                    ]
                },
                'norah' : {
                    'intro' : 'intro-2.mp3',
                    'start' : 'start.mp3',
                    'pause' : 'pause.mp3',
                    'pop' : [
                        'pop.mp3',
                        'pop2.mp3',
                        'pop3.mp3',
                        'pop4.mp3',
                        'pop5.mp3',
                        'pop6.mp3',
                        'pop7.mp3',
                        'pop8.mp3'
                    ]
                }
            };
            this.active_sounds = 'bubbadeem';
            this.sounds_audio = new Array();
            this.score = 0;
            this.sps = 0;
            this.highest_sps = 0;
            this.bubbles_spawned = 0;
            this.bubbles_popped = 0;
            this.bubbles_missed = 0;
            this.started = false;
            this.paused = false;
            this.ticks = 0;
            this.lang = 'en';
            this.pause_menu = {
                'buttons' : {
                    'dimensions' : [this.sizeUtil(475),this.sizeUtil(65)],
                    'resume' : {
                        'position' : [this.sizeUtil(262), this.sizeUtil(124)]
                    },
                    'restart' : {
                        'position' : [this.sizeUtil(262), this.sizeUtil(202)]
                    },
                    'quit' : {
                        'position' : [this.sizeUtil(262),this.sizeUtil(279)]
                    }
                },
                'panel' : {
                    'image': 'resources/svg/pause_background.svg',
                    'position' : [this.sizeUtil(250), this.sizeUtil(34)],
                    'dimensions' : [this.sizeUtil(500), this.sizeUtil(406)]
                }
            };
            this.panel = {
                'buttons' : {
                    'pause' : {
                        'position' : [this.sizeUtil(927), this.sizeUtil(487)],
                        'dimensions': [this.sizeUtil(65), this.sizeUtil(65)]
                    }
                }
            };
            this.made_by = 'Dad';

            if (settings !== null) {
                if ('fps' in settings) {
                    this.fps = settings['fps'];
                }

                if ('max_bubbles' in settings) {
                    this.max_bubbles = settings['max_bubbles'];
                }

                if ('bubble_image_code' in settings) {
                    this.bubble_image_code = settings['bubble_image_code'];
                }

                if ('colour_options' in settings && settings['colour_options'] instanceof Array) {
                    this.colour_options = settings['colour_options'];
                }

                if ('sounds' in settings) {
                    this.sounds = settings['sounds'];
                }

                if ('active_sounds' in settings) {
                    this.active_sounds = settings['active_sounds'];
                }

                if ('max_bubble_speed' in settings) {
                    this.max_bubble_speed = settings['max_bubble_speed'];
                }

                if ('lang' in settings) {
                    this.lang = settings['lang'];
                }

                if ('made_by' in settings) {
                    this.made_by = settings['made_by'];
                }
            }

            var script = document.createElement('script');
            script.src = 'resources/lang/'+ this.lang +'.js';
            document.head.appendChild(script); //or something of the likes

            this.fullscreenify = () => {
                var style = this.canvas.getAttribute('style') || '';

                window.addEventListener('resize', function () {resize(this.canvas);}, false);

                resize(this.canvas);

                function resize(canvas) {
                    var scale = Math.min(window.innerWidth/canvas.width,window.innerHeight/canvas.height);
                    canvas.setAttribute('style', style + ' ' + '-ms-transform-origin: left top; -webkit-transform-origin: left top; -moz-transform-origin: left top; -o-transform-origin: left top; transform-origin: left top; -ms-transform: scale(' + scale + ') translateX(-50%) translateY(-50%); -webkit-transform: scale3d(' + scale + ', 1) translateX(-50%) translateY(-50%); -moz-transform: scale(' + scale + ') translateX(-50%) translateY(-50%); -o-transform: scale(' + scale + ') translateX(-50%) translateY(-50%); transform: scale(' + scale + ') translateX(-50%) translateY(-50%);');
                }
            }

            this.clickCheckUtil = (pos, dim, event_pos) => {
                if (!pos instanceof Array && pos.length != 2)
                    return false
                if (!dim instanceof Array && dim.length != 2)
                    return false
                if (!event_pos instanceof Array && event_pos.length != 2)
                    return false

                var xmin = pos[0];
                var xmax = pos[0] + dim[0];

                var ymin = pos[1];
                var ymax = pos[1] + dim[1];

                if ( ( xmax > event_pos[0] && event_pos[0] > xmin ) && ( ymax > event_pos[1] && event_pos[1] > ymin ) )
                    return true;
                return false;
            }

            this.clickPopListener = (event) => {
                // console.log(event.offsetX + " " + event.offsetY);
                if (!this.paused && this.started) {
                    if (event.offsetY < this.gamearea.height) {
                        // Bubble area
                        for (i = 0; i < this.bubbles.length; i++) {
                            var bubble = this.bubbles[i];
                            if (bubble.clickCheck(event.offsetX, event.offsetY)) {
                                bubble.pop();
                                break;
                            }
                        }
                    } else {
                        // Panel buttons

                        // Pause button
                        if (this.clickCheckUtil(this.panel.buttons.pause.position, this.panel.buttons.pause.dimensions, [event.offsetX, event.offsetY]))
                            this.pause();
                    }
                }

                if (!this.started) {
                    // Detect click on start button
                    if ( (this.sizeUtil(650) > event.offsetX && event.offsetX > this.sizeUtil(350)) && (this.sizeUtil(412) > event.offsetY && event.offsetY > this.sizeUtil(300)) ) {
                        this.restart();
                    }

                    // Detect click on Github icon
                    if ( (this.sizeUtil(1000) > event.offsetX && event.offsetX > this.sizeUtil(1000 - 50)) && (this.sizeUtil(562) > event.offsetY && event.offsetY > this.sizeUtil(562 - 50)) ) {
                        window.open('https://github.com/twkm/bubbadeem');
                    }
                }

                if (this.paused) {
                    if (this.clickCheckUtil(this.pause_menu.buttons.resume.position, this.pause_menu.buttons.dimensions, [event.offsetX, event.offsetY]))
                        this.resume();

                    if (this.clickCheckUtil(this.pause_menu.buttons.restart.position, this.pause_menu.buttons.dimensions, [event.offsetX, event.offsetY]))
                        this.restart();

                    if (this.clickCheckUtil(this.pause_menu.buttons.quit.position, this.pause_menu.buttons.dimensions, [event.offsetX, event.offsetY]))
                        this.stop();
                }
            }

            this.init = (draw_cx) => {

                this.fullscreenify();

                this.draw_cx = draw_cx;

                canvas.addEventListener('click', this.clickPopListener, false);

                for (i=0; i < this.colour_options.length; i++) {
                    var image = new Image();
                    var image_data = this.bubble_image_code.replace(/#e82444/g, this.colour_options[i]);
                    image.src = image_data;
                    this.bubble_images.push(image);
                }

                this.sounds_audio['intro'] = new Audio('resources/sound/' + this.active_sounds + '/' + this.sounds[this.active_sounds]['intro']);
                this.sounds_audio['pause'] = new Audio('resources/sound/' + this.active_sounds + '/' + this.sounds[this.active_sounds]['pause']);
                this.sounds_audio['start'] = new Audio('resources/sound/' + this.active_sounds + '/' + this.sounds[this.active_sounds]['start']);
            }

            this.createBubbleCheck = (max_bubbles_override = null, fullscreen = false) => {

                var max_bubbles = (max_bubbles_override !== null) ? max_bubbles_override : this.max_bubbles;

                if (this.bubbles.length < max_bubbles) {
                    if ((this.bubbles.length == 0) || ((Math.random() * this.fps) >= (this.fps - 1))) {
                        var bubble = new Bubble(this, fullscreen);
                        this.bubbles.push(bubble);
                    }
                }
            }

            this.drawBubbles = () => {
                for (i = 0; i < this.bubbles.length; i++) {
                    this.bubbles[i].draw();
                }
            }

            this.redraw  = () => {

                this.current_time = new Date();
                this.delta = Math.abs(this.current_time-this.last_time);

                if(this.delta > this.interval) {

                    this.draw_cx.clearRect(0,0,this.canvas.width,this.canvas.height);

                    if (this.started) {
                        if (!this.paused) {
                            this.createBubbleCheck();
                            this.game_time += (this.delta % this.interval);
                        }

                        this.drawBubbles();
                        this.drawPanel();

                        if (this.paused) {
                            this.drawPauseMenu();
                        }

                    } else {
                        this.drawStartScreen();
                    }

                    this.sps = Math.round(this.score / (this.game_time / 1000));
                    if (this.sps > this.highest_sps)
                        this.highest_sps = this.sps;

                    this.lastTime = this.currentTime - (this.delta % this.interval);
                    this.ticks++;
                }

            }

            this.drawPauseMenu = () => {
                // Draw pause menu
                this.draw_cx.textAlign="center";
                this.draw_cx.fillStyle = "rgba(0, 0, 0, 0.75)";
                this.draw_cx.fillRect(0, 0, this.gamearea.width, this.gamearea.height);

                var panel_bg_img = new Image();
                panel_bg_img.src = 'resources/svg/pause_background.svg';
                this.draw_cx.drawImage(panel_bg_img, this.sizeUtil(250), this.sizeUtil(34), this.sizeUtil(500), this.sizeUtil(406));

                var button_img = new Image();
                button_img.src = 'resources/svg/pause_button.svg';

                this.draw_cx.fillStyle = "#FFF";
                this.draw_cx.font = "700 "+ this.sizeUtil(48) +"px Roboto";
                this.draw_cx.fillText(language['paused'], this.canvas.width / 2, this.pause_menu.panel.position[1] + this.sizeUtil(64));

                this.draw_cx.fillStyle = "#000";
                this.draw_cx.font = "700 "+ this.sizeUtil(48) +"px Roboto";
                // Resume
                this.draw_cx.drawImage(button_img, this.pause_menu.buttons.resume.position[0], this.pause_menu.buttons.resume.position[1], this.pause_menu.buttons.dimensions[0], this.pause_menu.buttons.dimensions[1]);
                this.draw_cx.fillText(language['resume'], this.canvas.width / 2, this.pause_menu.buttons.resume.position[1] + this.sizeUtil(49));
                // Restart
                this.draw_cx.drawImage(button_img, this.pause_menu.buttons.restart.position[0], this.pause_menu.buttons.restart.position[1], this.pause_menu.buttons.dimensions[0], this.pause_menu.buttons.dimensions[1]);
                this.draw_cx.fillText(language['restart'], this.canvas.width / 2, this.pause_menu.buttons.restart.position[1] + this.sizeUtil(49));
                // Quit
                this.draw_cx.drawImage(button_img, this.pause_menu.buttons.quit.position[0], this.pause_menu.buttons.quit.position[1], this.pause_menu.buttons.dimensions[0], this.pause_menu.buttons.dimensions[1]);
                this.draw_cx.font = "700 " +this.sizeUtil(48) +"px Roboto";
                this.draw_cx.fillText(language['quit'], this.canvas.width / 2, this.pause_menu.buttons.quit.position[1] + this.sizeUtil(49));
            }

            this.drawPanel = () => {
                this.draw_cx.fillStyle = "#000000";
                this.draw_cx.fillRect(0,this.gamearea.height,this.gamearea.width,this.sizeUtil(85));

                if (!this.paused) {
                    // Draw pause button
                    var pause_button = new Image();
                    pause_button.src = 'resources/svg/panel_pause_button.svg';
                    this.draw_cx.drawImage(pause_button, this.panel.buttons.pause.position[0], this.panel.buttons.pause.position[1], this.panel.buttons.pause.dimensions[0], this.panel.buttons.pause.dimensions[1]);
                }

                this.draw_cx.lineWidth = 0;
                this.draw_cx.strokeStyle = null;

                // Score per second
                this.draw_cx.fillStyle = "#FFF";
                this.draw_cx.font= this.sizeUtil(18) +"px Roboto";
                this.draw_cx.textAlign="left";
                this.draw_cx.fillText(language['score_per_second']+':', this.sizeUtil(10), this.canvas.height - this.sizeUtil(60));

                this.draw_cx.font="900 "+ this.sizeUtil(40) +"px Roboto";
                this.draw_cx.fillText(this.sps, this.sizeUtil(10), this.canvas.height - this.sizeUtil(16));

                // Highest Score per second
                this.draw_cx.fillStyle = "#FFF";
                this.draw_cx.font= this.sizeUtil(18) +"px Roboto";
                this.draw_cx.textAlign="left";
                this.draw_cx.fillText(language['highest_score_per_second']+':', this.sizeUtil(150), this.canvas.height - this.sizeUtil(60));

                this.draw_cx.font="900 "+ this.sizeUtil(40) +"px Roboto";
                this.draw_cx.fillText(this.highest_sps, this.sizeUtil(150), this.canvas.height - this.sizeUtil(16));

                // Score
                this.draw_cx.fillStyle = "#FFF";
                this.draw_cx.font= this.sizeUtil(18) +"px Roboto";
                this.draw_cx.textAlign="left";
                this.draw_cx.fillText(language['score']+':', this.sizeUtil(290), this.canvas.height - this.sizeUtil(60));

                this.draw_cx.font="900 "+ this.sizeUtil(40) +"px Roboto";
                this.draw_cx.fillText(this.score, this.sizeUtil(290), this.canvas.height - this.sizeUtil(16));

            }

            this.drawStartScreen = () => {

                this.createBubbleCheck(63, true);
                this.drawBubbles();

                // if (this.ticks == 0){
                //     this.animationQueue.push(new animatedText(this, "BUBBADEEM!", callback = addStartButton));
                // }

                this.draw_cx.fillStyle = "#000";
                this.draw_cx.font= this.sizeUtil(135) +"px Modak";
                this.draw_cx.textAlign="center";
                this.draw_cx.fillText(language['game'], this.canvas.width / 2, this.sizeUtil(250));
                this.draw_cx.lineWidth = this.sizeUtil(4);
                this.draw_cx.strokeStyle = "#FFF";
                this.draw_cx.strokeText(language['game'], this.canvas.width / 2, this.sizeUtil(250));

                // Can use the below button code to change background colour, like we do with the bubbles, rather than
                // using the button.svg file.
                var button_code = 'data:image/svg+xml;charset=utf-8,<?xml version="1.0" encoding="UTF-8" standalone="no"?>                <svg                   xmlns:dc="http://purl.org/dc/elements/1.1/"                   xmlns:cc="http://creativecommons.org/ns#"                   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"                   xmlns:svg="http://www.w3.org/2000/svg"                   xmlns="http://www.w3.org/2000/svg"                   xmlns:xlink="http://www.w3.org/1999/xlink"                   id="svg1520"                   version="1.1"                   viewBox="0 0 79.374016 29.66188"                   height="29.66188mm"                   width="79.374016mm">                  <defs                     id="defs1514">                    <linearGradient                       id="linearGradient2137">                      <stop                         style="stop-color:#ffffff;stop-opacity:0.5"                         offset="0"                         id="stop2133" />                      <stop                         style="stop-color:#4a4a4a;stop-opacity:0"                         offset="1"                         id="stop2135" />                    </linearGradient>                    <linearGradient                       gradientUnits="userSpaceOnUse"                       y2="44.97963"                       x2="87.169624"                       y1="57.274029"                       x1="87.169624"                       id="linearGradient2107"                       xlink:href="#linearGradient2137" />                  </defs>                  <metadata                     id="metadata1517">                    <rdf:RDF>                      <cc:Work                         rdf:about="">                        <dc:format>image/svg+xml</dc:format>                        <dc:type                           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />                        <dc:title></dc:title>                      </cc:Work>                    </rdf:RDF>                  </metadata>                  <g                     style="display:inline"                     id="layer3">                    <rect                       ry="2.5480402"                       rx="2.610929"                       y="0.94686645"                       x="0.93209398"                       height="27.76815"                       width="77.509819"                       id="rect837-6-0"                       style="opacity:1;fill:#7442fb;fill-opacity:0.5;stroke:none;stroke-width:0.80684924;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />                  </g>                  <g                     transform="translate(-51.02728,-29.680965)"                     id="layer1">                    <rect                       ry="2.645833"                       rx="2.6458333"                       y="30.094965"                       x="51.44128"                       height="28.833881"                       width="78.546013"                       id="rect837"                       style="opacity:1;fill:none;fill-opacity:1;stroke:#ffffff;stroke-width:0.82800001;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:0.98009949" />                    <rect                       ry="2.5480402"                       rx="2.610929"                       y="30.627832"                       x="51.959377"                       height="27.76815"                       width="77.509819"                       id="rect837-6"                       style="opacity:1;fill:url(#linearGradient2107);fill-opacity:1;stroke:#000000;stroke-width:0.80684924;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1;" />                  </g>                </svg>';

                var button_img = new Image();
                // var button_img_data = button_code.replace(/#e82444/g, this.colour_options[i]);
                button_img.src = 'resources/svg/button.svg';
                this.draw_cx.drawImage(button_img, this.sizeUtil(350), this.sizeUtil(300), this.sizeUtil(300), this.sizeUtil(112));

                this.draw_cx.font = "700 "+ this.sizeUtil(48) +"px Roboto";
                this.draw_cx.fillText(language['start'], this.canvas.width / 2, this.sizeUtil(373));

                // Draw the "Made with love by..." text
                this.draw_cx.textAlign="left";
                this.draw_cx.font = "500 "+ this.sizeUtil(24) +"px Roboto";

                var made_by_w = this.draw_cx.measureText(language['by'] + ' ' + this.made_by).width;
                var made_with_w = this.draw_cx.measureText(language['made_with']).width;

                var github_img = new Image();
                github_img.src = 'resources/svg/github.svg';
                var heart_img = new Image();
                heart_img.src = 'resources/svg/heart.svg';

                var current_x = this.sizeUtil(1000 - 10 - 30);
                var image_y = this.sizeUtil(562 - 10 - 30);
                var text_y = this.sizeUtil(562 - 16);

                this.draw_cx.drawImage(github_img, current_x, image_y, this.sizeUtil(30), this.sizeUtil(30));
                this.draw_cx.fillText(language['by'] + ' ' + this.made_by, current_x -= made_by_w + this.sizeUtil(10), text_y, made_by_w);
                this.draw_cx.drawImage(heart_img, current_x -= this.sizeUtil(30 + 10), image_y, this.sizeUtil(30), this.sizeUtil(30));
                this.draw_cx.fillText(language['made_with'], current_x -= made_with_w, text_y, made_with_w);

            }

            this.pause = () => {
                if (this.started) {
                    this.paused = true;
                    this.sounds_audio['pause'].play();
                } else {
                    return false;
                }
            }

            this.resume = () => {
                this.paused = false;
            }

            this.restart = () => {
                this.bubbles.length = 0;
                this.bubbles_spawned = 0;
                this.bubbles_missed = 0;
                this.bubbles_popped = 0;
                this.score = 0;
                this.sps = 0;
                this.highest_sps = 0;
                this.started = true;
                this.paused = false;
                this.sounds_audio['intro'].play();
                this.game_time = 0;
            }

            this.stop = () => {
                this.bubbles.length = 0;
                this.started = false;
                this.paused = false;
            }
        }

        function Bubble (game, fullscreen) {
            this.game = game;
            this.base_size = this.game.sizeUtil(65);
            this.base_speed = this.game.sizeUtil(30) / this.game.fps;
            this.posX = false;
            this.posY = false;
            this.popped = false;
            this.image = null;
            this.path_angle = 90;
            this.last_path_update = null;
            this.current_time = this.game.current_time;
            this.score = 0;
            this.fullscreen = fullscreen;

            this.setup = (canvas) => {
                this.size = this.base_size + (Math.random() * this.game.sizeUtil(65)) + 1;
                // random between 0 and 4
                this.speed = this.base_speed + (Math.random() * (this.base_speed * this.game.max_bubble_speed));
                this.posX = (Math.random() * canvas.width) + this.game.sizeUtil(1);
                if (this.fullscreen) {
                    this.posY = this.game.canvas.height + (this.size / 2);
                } else {
                    this.posY = this.game.gamearea.height + (this.size / 2);
                }
                this.image = this.game.bubble_images[Math.floor(Math.random() * this.game.bubble_images.length)];
                // Random between 65 and 125 degrees
                this.path_angle = 65 + (Math.random() * 50);
                this.last_path_update = (new Date()).getTime();

                // Score is 65% based on speed, 35% based on size
                // Max score for a bubble is 100
                var speed_score = (this.speed / (this.base_speed + this.game.max_bubble_speed)) * 0.65;
                var size_score = (this.size / (this.base_size + 65 + 1)) * 0.35;
                this.score = Math.floor((speed_score + size_score) * 100);

                this.game.bubbles_spawned++;
            }

            this.draw = () => {

                if (!this.game.paused) {
                    if (this.posX === false) {
                        this.setup(this.game.canvas);
                    } else {
                        this.path_update_check();
                        // The math: http://www.helixsoft.nl/articles/circle/sincos.htm
                        this.posX -= this.speed * Math.cos(this.path_angle * Math.PI / 180);
                        this.posY -= this.speed * Math.sin(this.path_angle * Math.PI / 180);
                    }
                }

                if (this.posY < (0 - (this.size / 2)) || this.posX < (0 - (this.size / 2))) {
                    this.remove();
                } else {
                    this.game.draw_cx.drawImage(this.image, this.posX - (this.size / 2), this.posY - (this.size / 2), this.size, this.size);
                }
            }

            this.path_update_check = () => {
                var low = 1000;
                var high = 4000;

                var path_delta = this.game.current_time - this.last_path_update;

                if (path_delta > high) {
                    // force update
                    this.path_update();
                } else if (path_delta > low) {
                    // 1 chance per second
                    if ((Math.random() * this.game.fps) >= (this.game.fps - 1)) {
                        this.path_update();
                    }
                }
            }

            this.path_update = () => {
                // Sway back and forth
                if (this.path_angle > 90) {
                    this.path_angle = 65 + (Math.random() * 25);
                } else if (this.path_angle < 90) {
                    this.path_angle = 90 + (Math.random() * 25);
                } else {
                    this.path_angle = 65 + (Math.random() * 50);
                }
                this.last_path_update = (new Date()).getTime();
            }

            this.pop = () => {
                this.pop_audio();
                this.popped = true;
                this.game.score += this.score;
                this.remove();
                this.game.bubbles_popped++;
            }

            this.pop_audio = () => {
                sound = new Audio('resources/sound/' + this.game.active_sounds + '/pop/' + this.game.sounds[this.game.active_sounds]['pop'][Math.floor(Math.random() * this.game.sounds[this.game.active_sounds]['pop'].length)] ).play();
            }

            this.remove = () => {
                var this_bubble = this.game.bubbles.indexOf(this);
                if (!this.popped)
                    this.game.bubbles_missed++;
                this.game.bubbles.splice(this_bubble,1);
            }

            this.clickCheck = (x, y) => {
                if (Math.sqrt((x-this.posX)*(x-this.posX) + (y-this.posY)*(y-this.posY)) < (this.size / 2)) {
                    return true;
                }
                return false;
            }

        }

        function mainLoop() {
            window.requestAnimationFrame(mainLoop);
            game.redraw();
        }

        var canvas, game;

        window.addEventListener(
            'load',
            function () {

                canvas = document.getElementsByTagName('canvas')[0];
                game = new Bubbadeem(canvas, { 'active_sounds': 'norah', 'max_bubbles' : 5, 'max_bubble_speed' : 2 });

                var vendors = ['webkit', 'moz'];
                for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                    window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
                    window.cancelAnimationFrame =
                      window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
                }

                if (!window.requestAnimationFrame)
                    window.requestAnimationFrame = function(callback, element) {
                        var currTime = new Date().getTime();
                        var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                        var id = window.setTimeout(function() { callback(currTime + timeToCall); },
                          timeToCall);
                        lastTime = currTime + timeToCall;
                        return id;
                    };

                if (!window.cancelAnimationFrame)
                    window.cancelAnimationFrame = function(id) {
                        clearTimeout(id);
                    };

                if (typeof (canvas.getContext) !== undefined) {
                    cx = canvas.getContext('2d');

                    game.init(cx);
                    mainLoop(game);

                }
            },
            false
        );

    </script>
</head>
<body oncontextmenu="return false;">
    <!--
    Uncomment the canvas resolution you want to use below.
    There should only be one <canvas> element uncommented.
    Custom sizes can be entered, just make sure it is a 16:9 ratio
    -->
    <!-- <canvas id="game_canvas" width="3840" height="2160"></canvas> -->
    <!-- <canvas id="game_canvas" width="2560" height="1440"></canvas> -->
    <canvas id="game_canvas" width="1920" height="1080"></canvas>
    <!-- <canvas id="game_canvas" width="1366" height="768"></canvas> -->
    <!-- <canvas id="game_canvas" width="1280" height="720"></canvas> -->
    <!-- <canvas id="game_canvas" width="1000" height="562"></canvas> -->
</body>
</html>
